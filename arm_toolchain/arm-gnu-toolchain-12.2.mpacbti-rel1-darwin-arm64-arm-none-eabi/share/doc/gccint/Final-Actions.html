<html lang="en">
<head>
<title>Final Actions - GNU Compiler Collection (GCC) Internals</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="GNU Compiler Collection (GCC) Internals">
<meta name="generator" content="makeinfo 4.8">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="Test-Directives.html#Test-Directives" title="Test Directives">
<link rel="prev" href="Require-Support.html#Require-Support" title="Require Support">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
Copyright (C) 1988-2022 Free Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being ``Funding Free Software'', the Front-Cover
Texts being (a) (see below), and with the Back-Cover Texts being (b)
(see below).  A copy of the license is included in the section entitled
``GNU Free Documentation License''.

(a) The FSF's Front-Cover Text is:

     A GNU Manual

(b) The FSF's Back-Cover Text is:

     You have freedom to copy and modify this GNU Manual, like GNU
     software.  Copies published by the Free Software Foundation raise
     funds for GNU development.-->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<p>
<a name="Final-Actions"></a>
Previous:&nbsp;<a rel="previous" accesskey="p" href="Require-Support.html#Require-Support">Require Support</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="Test-Directives.html#Test-Directives">Test Directives</a>
<hr>
</div>

<h4 class="subsection">7.2.7 Commands for use in <code>dg-final</code></h4>

<p>The GCC testsuite defines the following directives to be used within
<code>dg-final</code>.

<h5 class="subsubsection">7.2.7.1 Scan a particular file</h5>

     <dl>
<dt><code>scan-file </code><var>filename</var> <var>regexp</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if <var>regexp</var> matches text in <var>filename</var>. 
<br><dt><code>scan-file-not </code><var>filename</var> <var>regexp</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if <var>regexp</var> does not match text in <var>filename</var>. 
<br><dt><code>scan-module </code><var>module</var> <var>regexp</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if <var>regexp</var> matches in Fortran module <var>module</var>. 
<br><dt><code>dg-check-dot </code><var>filename</var><dd>Passes if <var>filename</var> is a valid <samp><span class="file">.dot</span></samp> file (by running
<code>dot -Tpng</code> on it, and verifying the exit code is 0). 
</dl>

<h5 class="subsubsection">7.2.7.2 Scan the assembly output</h5>

     <dl>
<dt><code>scan-assembler </code><var>regex</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if <var>regex</var> matches text in the test's assembler output.

     <br><dt><code>scan-assembler-not </code><var>regex</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if <var>regex</var> does not match text in the test's assembler output.

     <br><dt><code>scan-assembler-times </code><var>regex</var> <var>num</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if <var>regex</var> is matched exactly <var>num</var> times in the test's
assembler output.

     <br><dt><code>scan-assembler-dem </code><var>regex</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if <var>regex</var> matches text in the test's demangled assembler output.

     <br><dt><code>scan-assembler-dem-not </code><var>regex</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if <var>regex</var> does not match text in the test's demangled assembler
output.

     <br><dt><code>scan-assembler-symbol-section </code><var>functions</var> <var>section</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if <var>functions</var> are all in <var>section</var>.  The caller needs to
allow for <code>USER_LABEL_PREFIX</code> and different section name conventions.

     <br><dt><code>scan-symbol-section </code><var>filename</var> <var>functions</var> <var>section</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if <var>functions</var> are all in <var>section</var>in <var>filename</var>. 
The same caveats as for <code>scan-assembler-symbol-section</code> apply.

     <br><dt><code>scan-hidden </code><var>symbol</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if <var>symbol</var> is defined as a hidden symbol in the test's
assembly output.

     <br><dt><code>scan-not-hidden </code><var>symbol</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if <var>symbol</var> is not defined as a hidden symbol in the test's
assembly output.

     <br><dt><code>check-function-bodies </code><var>prefix</var> <var>terminator</var><code> [</code><var>options</var><code> [{ target/xfail </code><var>selector</var><code> }]]</code><dd>Looks through the source file for comments that give the expected assembly
output for selected functions.  Each line of expected output starts with the
prefix string <var>prefix</var> and the expected output for a function as a whole
is followed by a line that starts with the string <var>terminator</var>. 
Specifying an empty terminator is equivalent to specifying `<samp><span class="samp">"*/"</span></samp>'.

     <p><var>options</var>, if specified, is a list of regular expressions, each of
which matches a full command-line option.  A non-empty list prevents
the test from running unless all of the given options are present on the
command line.  This can help if a source file is compiled both with
and without optimization, since it is rarely useful to check the full
function body for unoptimized code.

     <p>The first line of the expected output for a function <var>fn</var> has the form:

     <pre class="smallexample">          <var>prefix</var> <var>fn</var>:  [{ target/xfail <var>selector</var> }]
     </pre>
     <p>Subsequent lines of the expected output also start with <var>prefix</var>. 
In both cases, whitespace after <var>prefix</var> is not significant.

     <p>The test discards assembly directives such as <code>.cfi_startproc</code>
and local label definitions such as <code>.LFB0</code> from the compiler's
assembly output.  It then matches the result against the expected
output for a function as a single regular expression.  This means that
later lines can use backslashes to refer back to `<samp><span class="samp">(...)</span></samp>'
captures on earlier lines.  For example:

     <pre class="smallexample">          /* { dg-final { check-function-bodies "**" "" "-DCHECK_ASM" } } */
          ...
          /*
          ** add_w0_s8_m:
          **	mov	(z[0-9]+\.b), w0
          **	add	z0\.b, p0/m, z0\.b, \1
          **	ret
          */
          svint8_t add_w0_s8_m (...) { ... }
          ...
          /*
          ** add_b0_s8_m:
          **	mov	(z[0-9]+\.b), b0
          **	add	z1\.b, p0/m, z1\.b, \1
          **	ret
          */
          svint8_t add_b0_s8_m (...) { ... }
     </pre>
     <p>checks whether the implementations of <code>add_w0_s8_m</code> and
<code>add_b0_s8_m</code> match the regular expressions given.  The test only
runs when `<samp><span class="samp">-DCHECK_ASM</span></samp>' is passed on the command line.

     <p>It is possible to create non-capturing multi-line regular expression
groups of the form `<samp><span class="samp">(</span><var>a</var><span class="samp">|</span><var>b</var><span class="samp">|...)</span></samp>' by putting the
`<samp><span class="samp">(</span></samp>', `<samp><span class="samp">|</span></samp>' and `<samp><span class="samp">)</span></samp>' on separate lines (each still using
<var>prefix</var>).  For example:

     <pre class="smallexample">          /*
          ** cmple_f16_tied:
          ** (
          **	fcmge	p0\.h, p0/z, z1\.h, z0\.h
          ** |
          **	fcmle	p0\.h, p0/z, z0\.h, z1\.h
          ** )
          **	ret
          */
          svbool_t cmple_f16_tied (...) { ... }
     </pre>
     <p>checks whether <code>cmple_f16_tied</code> is implemented by the
<code>fcmge</code> instruction followed by <code>ret</code> or by the
<code>fcmle</code> instruction followed by <code>ret</code>.  The test is
still a single regular rexpression.

     <p>A line containing just:

     <pre class="smallexample">          <var>prefix</var> ...
     </pre>
     <p>stands for zero or more unmatched lines; the whitespace after
<var>prefix</var> is again not significant.

</dl>

<h5 class="subsubsection">7.2.7.3 Scan optimization dump files</h5>

<p>These commands are available for <var>kind</var> of <code>tree</code>, <code>ltrans-tree</code>,
<code>offload-tree</code>, <code>rtl</code>, <code>offload-rtl</code>, <code>ipa</code>, and
<code>wpa-ipa</code>.

     <dl>
<dt><code>scan-</code><var>kind</var><code>-dump </code><var>regex</var> <var>suffix</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if <var>regex</var> matches text in the dump file with suffix <var>suffix</var>.

     <br><dt><code>scan-</code><var>kind</var><code>-dump-not </code><var>regex</var> <var>suffix</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if <var>regex</var> does not match text in the dump file with suffix
<var>suffix</var>.

     <br><dt><code>scan-</code><var>kind</var><code>-dump-times </code><var>regex</var> <var>num</var> <var>suffix</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if <var>regex</var> is found exactly <var>num</var> times in the dump file
with suffix <var>suffix</var>.

     <br><dt><code>scan-</code><var>kind</var><code>-dump-dem </code><var>regex</var> <var>suffix</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if <var>regex</var> matches demangled text in the dump file with
suffix <var>suffix</var>.

     <br><dt><code>scan-</code><var>kind</var><code>-dump-dem-not </code><var>regex</var> <var>suffix</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if <var>regex</var> does not match demangled text in the dump file with
suffix <var>suffix</var>. 
</dl>

 <p>The <var>suffix</var> argument which describes the dump file to be scanned
may contain a glob pattern that must expand to exactly one file
name. This is useful if, e.g., different pass instances are executed
depending on torture testing command-line flags, producing dump files
whose names differ only in their pass instance number suffix.  For
example, to scan instances 1, 2, 3 of a tree pass &ldquo;mypass&rdquo; for
occurrences of the string &ldquo;code has been optimized&rdquo;, use:
<pre class="smallexample">     /* { dg-options "-fdump-tree-mypass" } */
     /* { dg-final { scan-tree-dump "code has been optimized" "mypass\[1-3\]" } } */
</pre>
 <h5 class="subsubsection">7.2.7.4 Check for output files</h5>

     <dl>
<dt><code>output-exists [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if compiler output file exists.

     <br><dt><code>output-exists-not [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if compiler output file does not exist.

     <br><dt><code>scan-symbol </code><var>regexp</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if the pattern is present in the final executable.

     <br><dt><code>scan-symbol-not </code><var>regexp</var><code> [{ target/xfail </code><var>selector</var><code> }]</code><dd>Passes if the pattern is absent from the final executable. 
</dl>

<h5 class="subsubsection">7.2.7.5 Checks for <samp><span class="command">gcov</span></samp> tests</h5>

     <dl>
<dt><code>run-gcov </code><var>sourcefile</var><dd>Check line counts in <samp><span class="command">gcov</span></samp> tests.

     <br><dt><code>run-gcov [branches] [calls] { </code><var>opts</var> <var>sourcefile</var><code> }</code><dd>Check branch and/or call counts, in addition to line counts, in
<samp><span class="command">gcov</span></samp> tests.

     <br><dt><code>run-gcov-pytest { </code><var>sourcefile</var> <var>pytest_file</var><code> }</code><dd>Check output of <samp><span class="command">gcov</span></samp> intermediate format with a pytest
script. 
</dl>

<h5 class="subsubsection">7.2.7.6 Clean up generated test files</h5>

<p>Usually the test-framework removes files that were generated during
testing. If a testcase, for example, uses any dumping mechanism to
inspect a passes dump file, the testsuite recognized the dump option
passed to the tool and schedules a final cleanup to remove these files.

 <p>There are, however, following additional cleanup directives that can be
used to annotate a testcase "manually".
     <dl>
<dt><code>cleanup-coverage-files</code><dd>Removes coverage data files generated for this test.

     <br><dt><code>cleanup-modules "</code><var>list-of-extra-modules</var><code>"</code><dd>Removes Fortran module files generated for this test, excluding the
module names listed in keep-modules. 
Cleaning up module files is usually done automatically by the testsuite
by looking at the source files and removing the modules after the test
has been executed.
     <pre class="smallexample">          module MoD1
          end module MoD1
          module Mod2
          end module Mod2
          module moD3
          end module moD3
          module mod4
          end module mod4
          ! { dg-final { cleanup-modules "mod1 mod2" } } ! redundant
          ! { dg-final { keep-modules "mod3 mod4" } }
     </pre>
     <br><dt><code>keep-modules "</code><var>list-of-modules-not-to-delete</var><code>"</code><dd>Whitespace separated list of module names that should not be deleted by
cleanup-modules. 
If the list of modules is empty, all modules defined in this file are kept.
     <pre class="smallexample">          module maybe_unneeded
          end module maybe_unneeded
          module keep1
          end module keep1
          module keep2
          end module keep2
          ! { dg-final { keep-modules "keep1 keep2" } } ! just keep these two
          ! { dg-final { keep-modules "" } } ! keep all
     </pre>
     <br><dt><code>dg-keep-saved-temps "</code><var>list-of-suffixes-not-to-delete</var><code>"</code><dd>Whitespace separated list of suffixes that should not be deleted
automatically in a testcase that uses <samp><span class="option">-save-temps</span></samp>.
     <pre class="smallexample">          // { dg-options "-save-temps -fpch-preprocess -I." }
          int main() { return 0; }
          // { dg-keep-saved-temps ".s" } ! just keep assembler file
          // { dg-keep-saved-temps ".s" ".i" } ! ... and .i
          // { dg-keep-saved-temps ".ii" ".o" } ! or just .ii and .o
     </pre>
     <br><dt><code>cleanup-profile-file</code><dd>Removes profiling files generated for this test.

 </dl>

 </body></html>

