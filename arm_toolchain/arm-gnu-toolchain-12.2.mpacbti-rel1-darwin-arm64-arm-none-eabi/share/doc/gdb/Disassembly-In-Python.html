<html lang="en">
<head>
<title>Disassembly In Python - Debugging with GDB</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="Debugging with GDB">
<meta name="generator" content="makeinfo 4.8">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="Python-API.html#Python-API" title="Python API">
<link rel="prev" href="TUI-Windows-In-Python.html#TUI-Windows-In-Python" title="TUI Windows In Python">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
Copyright (C) 1988-2023 Free Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being ``Free Software'' and ``Free Software Needs
Free Documentation'', with the Front-Cover Texts being ``A GNU Manual,''
and with the Back-Cover Texts as in (a) below.

(a) The FSF's Back-Cover Text is: ``You are free to copy and modify
this GNU Manual.  Buying copies from GNU Press supports the FSF in
developing GNU and promoting software freedom.''
-->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<p>
<a name="Disassembly-In-Python"></a>
Previous:&nbsp;<a rel="previous" accesskey="p" href="TUI-Windows-In-Python.html#TUI-Windows-In-Python">TUI Windows In Python</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="Python-API.html#Python-API">Python API</a>
<hr>
</div>

<h5 class="subsubsection">23.3.2.38 Instruction Disassembly In Python</h5>

<p><a name="index-python-instruction-disassembly-2647"></a>
<span class="sc">gdb</span>'s builtin disassembler can be extended, or even replaced,
using the Python API.  The disassembler related features are contained
within the <code>gdb.disassembler</code> module:

<div class="defun">
&mdash; class: <b>gdb.disassembler.DisassembleInfo</b><var><a name="index-gdb_002edisassembler_002eDisassembleInfo-2648"></a></var><br>
<blockquote><p>Disassembly is driven by instances of this class.  Each time
<span class="sc">gdb</span> needs to disassemble an instruction, an instance of this
class is created and passed to a registered disassembler.  The
disassembler is then responsible for disassembling an instruction and
returning a result.

        <p>Instances of this type are usually created within <span class="sc">gdb</span>,
however, it is possible to create a copy of an instance of this type,
see the description of <code>__init__</code> for more details.

        <p>This class has the following properties and methods:

     <div class="defun">
&mdash; Variable: <b>DisassembleInfo.address</b><var><a name="index-DisassembleInfo_002eaddress-2649"></a></var><br>
<blockquote><p>A read-only integer containing the address at which <span class="sc">gdb</span>
wishes to disassemble a single instruction. 
</p></blockquote></div>

     <div class="defun">
&mdash; Variable: <b>DisassembleInfo.architecture</b><var><a name="index-DisassembleInfo_002earchitecture-2650"></a></var><br>
<blockquote><p>The <code>gdb.Architecture</code> (see <a href="Architectures-In-Python.html#Architectures-In-Python">Architectures In Python</a>) for
which <span class="sc">gdb</span> is currently disassembling, this property is
read-only. 
</p></blockquote></div>

     <div class="defun">
&mdash; Variable: <b>DisassembleInfo.progspace</b><var><a name="index-DisassembleInfo_002eprogspace-2651"></a></var><br>
<blockquote><p>The <code>gdb.Progspace</code> (see <a href="Progspaces-In-Python.html#Progspaces-In-Python">Program Spaces In Python</a>) for which <span class="sc">gdb</span> is currently disassembling, this
property is read-only. 
</p></blockquote></div>

     <div class="defun">
&mdash; Function: <b>DisassembleInfo.is_valid</b> ()<var><a name="index-DisassembleInfo_002eis_005fvalid-2652"></a></var><br>
<blockquote><p>Returns <code>True</code> if the <code>DisassembleInfo</code> object is valid,
<code>False</code> if not.  A <code>DisassembleInfo</code> object will become
invalid once the disassembly call for which the <code>DisassembleInfo</code>
was created, has returned.  Calling other <code>DisassembleInfo</code>
methods, or accessing <code>DisassembleInfo</code> properties, will raise a
<code>RuntimeError</code> exception if it is invalid. 
</p></blockquote></div>

     <div class="defun">
&mdash; Function: <b>DisassembleInfo.__init__</b> (<var>info</var>)<var><a name="index-DisassembleInfo_002e_005f_005finit_005f_005f-2653"></a></var><br>
<blockquote><p>This can be used to create a new <code>DisassembleInfo</code> object that is
a copy of <var>info</var>.  The copy will have the same <code>address</code>,
<code>architecture</code>, and <code>progspace</code> values as <var>info</var>, and
will become invalid at the same time as <var>info</var>.

             <p>This method exists so that sub-classes of <code>DisassembleInfo</code> can
be created, these sub-classes must be initialized as copies of an
existing <code>DisassembleInfo</code> object, but sub-classes might choose
to override the <code>read_memory</code> method, and so control what
<span class="sc">gdb</span> sees when reading from memory
(see <a href="builtin_005fdisassemble.html#builtin_005fdisassemble">builtin_disassemble</a>). 
</p></blockquote></div>

     <div class="defun">
&mdash; Function: <b>DisassembleInfo.read_memory</b> (<var>length, offset</var>)<var><a name="index-DisassembleInfo_002eread_005fmemory-2654"></a></var><br>
<blockquote><p>This method allows the disassembler to read the bytes of the
instruction to be disassembled.  The method reads <var>length</var> bytes,
starting at <var>offset</var> from
<code>DisassembleInfo.address</code>.

             <p>It is important that the disassembler read the instruction bytes using
this method, rather than reading inferior memory directly, as in some
cases <span class="sc">gdb</span> disassembles from an internal buffer rather than
directly from inferior memory, calling this method handles this
detail.

             <p>Returns a buffer object, which behaves much like an array or a string,
just as <code>Inferior.read_memory</code> does
(see <a href="gdbpy_005finferior_005fread_005fmemory.html#gdbpy_005finferior_005fread_005fmemory">Inferior.read_memory</a>).  The
length of the returned buffer will always be exactly <var>length</var>.

             <p>If <span class="sc">gdb</span> is unable to read the required memory then a
<code>gdb.MemoryError</code> exception is raised (see <a href="Exception-Handling.html#Exception-Handling">Exception Handling</a>).

             <p>This method can be overridden by a sub-class in order to control what
<span class="sc">gdb</span> sees when reading from memory
(see <a href="builtin_005fdisassemble.html#builtin_005fdisassemble">builtin_disassemble</a>).  When overriding this method it is
important to understand how <code>builtin_disassemble</code> makes use of
this method.

             <p>While disassembling a single instruction there could be multiple calls
to this method, and the same bytes might be read multiple times.  Any
single call might only read a subset of the total instruction bytes.

             <p>If an implementation of <code>read_memory</code> is unable to read the
requested memory contents, for example, if there's a request to read
from an invalid memory address, then a <code>gdb.MemoryError</code> should
be raised.

             <p>Raising a <code>MemoryError</code> inside <code>read_memory</code> does not
automatically mean a <code>MemoryError</code> will be raised by
<code>builtin_disassemble</code>.  It is possible the <span class="sc">gdb</span>'s builtin
disassembler is probing to see how many bytes are available.  When
<code>read_memory</code> raises the <code>MemoryError</code> the builtin
disassembler might be able to perform a complete disassembly with the
bytes it has available, in this case <code>builtin_disassemble</code> will
not itself raise a <code>MemoryError</code>.

             <p>Any other exception type raised in <code>read_memory</code> will propagate
back and be re-raised by <code>builtin_disassemble</code>. 
</p></blockquote></div>
        </p></blockquote></div>

<div class="defun">
&mdash; class: <b>Disassembler</b><var><a name="index-Disassembler-2655"></a></var><br>
<blockquote><p>This is a base class from which all user implemented disassemblers
must inherit.

     <div class="defun">
&mdash; Function: <b>Disassembler.__init__</b> (<var>name</var>)<var><a name="index-Disassembler_002e_005f_005finit_005f_005f-2656"></a></var><br>
<blockquote><p>The constructor takes <var>name</var>, a string, which should be a short
name for this disassembler. 
</p></blockquote></div>

     <div class="defun">
&mdash; Function: <b>Disassembler.__call__</b> (<var>info</var>)<var><a name="index-Disassembler_002e_005f_005fcall_005f_005f-2657"></a></var><br>
<blockquote><p>The <code>__call__</code> method must be overridden by sub-classes to
perform disassembly.  Calling <code>__call__</code> on this base class will
raise a <code>NotImplementedError</code> exception.

             <p>The <var>info</var> argument is an instance of <code>DisassembleInfo</code>, and
describes the instruction that <span class="sc">gdb</span> wants disassembling.

             <p>If this function returns <code>None</code>, this indicates to <span class="sc">gdb</span>
that this sub-class doesn't wish to disassemble the requested
instruction.  <span class="sc">gdb</span> will then use its builtin disassembler to
perform the disassembly.

             <p>Alternatively, this function can return a <code>DisassemblerResult</code>
that represents the disassembled instruction, this type is described
in more detail below.

             <p>The <code>__call__</code> method can raise a <code>gdb.MemoryError</code>
exception (see <a href="Exception-Handling.html#Exception-Handling">Exception Handling</a>) to indicate to <span class="sc">gdb</span>
that there was a problem accessing the required memory, this will then
be displayed by <span class="sc">gdb</span> within the disassembler output.

             <p>Ideally, the only three outcomes from invoking <code>__call__</code> would
be a return of <code>None</code>, a successful disassembly returned in a
<code>DisassemblerResult</code>, or a <code>MemoryError</code> indicating that
there was a problem reading memory.

             <p>However, as an implementation of <code>__call__</code> could fail due to
other reasons, e.g. some external resource required to perform
disassembly is temporarily unavailable, then, if <code>__call__</code>
raises a <code>GdbError</code>, the exception will be converted to a string
and printed at the end of the disassembly output, the disassembly
request will then stop.

             <p>Any other exception type raised by the <code>__call__</code> method is
considered an error in the user code, the exception will be printed to
the error stream according to the <kbd>set python print-stack</kbd> setting
(see <a href="set_005fpython_005fprint_005fstack.html#set_005fpython_005fprint_005fstack"><kbd>set python print-stack</kbd></a>). 
</p></blockquote></div>
        </p></blockquote></div>

<div class="defun">
&mdash; class: <b>DisassemblerResult</b><var><a name="index-DisassemblerResult-2658"></a></var><br>
<blockquote><p>This class is used to hold the result of calling
<code>Disassembler.__call__</code><!-- /@w -->, and represents a single disassembled
instruction.  This class has the following properties and methods:

     <div class="defun">
&mdash; Function: <b>DisassemblerResult.__init__</b> (<var>length, string</var>)<var><a name="index-DisassemblerResult_002e_005f_005finit_005f_005f-2659"></a></var><br>
<blockquote><p>Initialize an instance of this class, <var>length</var> is the length of
the disassembled instruction in bytes, which must be greater than
zero, and <var>string</var> is a non-empty string that represents the
disassembled instruction. 
</p></blockquote></div>

     <div class="defun">
&mdash; Variable: <b>DisassemblerResult.length</b><var><a name="index-DisassemblerResult_002elength-2660"></a></var><br>
<blockquote><p>A read-only property containing the length of the disassembled
instruction in bytes, this will always be greater than zero. 
</p></blockquote></div>

     <div class="defun">
&mdash; Variable: <b>DisassemblerResult.string</b><var><a name="index-DisassemblerResult_002estring-2661"></a></var><br>
<blockquote><p>A read-only property containing a non-empty string representing the
disassembled instruction. 
</p></blockquote></div>
        </p></blockquote></div>

   <p>The following functions are also contained in the
<code>gdb.disassembler</code> module:

<div class="defun">
&mdash; Function: <b>register_disassembler</b> (<var>disassembler, architecture</var>)<var><a name="index-register_005fdisassembler-2662"></a></var><br>
<blockquote><p>The <var>disassembler</var> must be a sub-class of
<code>gdb.disassembler.Disassembler</code> or <code>None</code>.

        <p>The optional <var>architecture</var> is either a string, or the value
<code>None</code>.  If it is a string, then it should be the name of an
architecture known to <span class="sc">gdb</span>, as returned either from
<code>gdb.Architecture.name</code>
(see <a href="gdbpy_005farchitecture_005fname.html#gdbpy_005farchitecture_005fname">gdb.Architecture.name</a>), or from
<code>gdb.architecture_names</code>
(see <a href="gdb_005farchitecture_005fnames.html#gdb_005farchitecture_005fnames">gdb.architecture_names</a>).

        <p>The <var>disassembler</var> will be installed for the architecture named by
<var>architecture</var>, or if <var>architecture</var> is <code>None</code>, then
<var>disassembler</var> will be installed as a global disassembler for use
by all architectures.

        <p><a name="index-disassembler-in-Python_002c-global-vs_002e_0040_003a-specific-2663"></a><a name="index-search-order-for-disassembler-in-Python-2664"></a><a name="index-look-up-of-disassembler-in-Python-2665"></a><span class="sc">gdb</span> only records a single disassembler for each architecture,
and a single global disassembler.  Calling
<code>register_disassembler</code> for an architecture, or for the global
disassembler, will replace any existing disassembler registered for
that <var>architecture</var> value.  The previous disassembler is returned.

        <p>If <var>disassembler</var> is <code>None</code> then any disassembler currently
registered for <var>architecture</var> is deregistered and returned.

        <p>When <span class="sc">gdb</span> is looking for a disassembler to use, <span class="sc">gdb</span>
first looks for an architecture specific disassembler.  If none has
been registered then <span class="sc">gdb</span> looks for a global disassembler (one
registered with <var>architecture</var> set to <code>None</code>).  Only one
disassembler is called to perform disassembly, so, if there is both an
architecture specific disassembler, and a global disassembler
registered, it is the architecture specific disassembler that will be
used.

        <p><span class="sc">gdb</span> tracks the architecture specific, and global
disassemblers separately, so it doesn't matter in which order
disassemblers are created or registered; an architecture specific
disassembler, if present, will always be used in preference to a
global disassembler.

        <p>You can use the <kbd>maint info python-disassemblers</kbd> command
(see <a href="maint-info-python_002ddisassemblers.html#maint-info-python_002ddisassemblers">maint info python-disassemblers</a>) to see which disassemblers
have been registered. 
</p></blockquote></div>

   <p><a name="builtin_005fdisassemble"></a>

<div class="defun">
&mdash; Function: <b>builtin_disassemble</b> (<var>info</var>)<var><a name="index-builtin_005fdisassemble-2666"></a></var><br>
<blockquote><p>This function calls back into <span class="sc">gdb</span>'s builtin disassembler to
disassemble the instruction identified by <var>info</var>, an instance, or
sub-class, of <code>DisassembleInfo</code>.

        <p>When the builtin disassembler needs to read memory the
<code>read_memory</code> method on <var>info</var> will be called.  By
sub-classing <code>DisassembleInfo</code> and overriding the
<code>read_memory</code> method, it is possible to intercept calls to
<code>read_memory</code> from the builtin disassembler, and to modify the
values returned.

        <p>It is important to understand that, even when
<code>DisassembleInfo.read_memory</code> raises a <code>gdb.MemoryError</code>, it
is the internal disassembler itself that reports the memory error to
<span class="sc">gdb</span>.  The reason for this is that the disassembler might
probe memory to see if a byte is readable or not; if the byte can't be
read then the disassembler may choose not to report an error, but
instead to disassemble the bytes that it does have available.

        <p>If the builtin disassembler is successful then an instance of
<code>DisassemblerResult</code> is returned from <code>builtin_disassemble</code>,
alternatively, if something goes wrong, an exception will be raised.

        <p>A <code>MemoryError</code> will be raised if <code>builtin_disassemble</code> is
unable to read some memory that is required in order to perform
disassembly correctly.

        <p>Any exception that is not a <code>MemoryError</code>, that is raised in a
call to <code>read_memory</code>, will pass through
<code>builtin_disassemble</code>, and be visible to the caller.

        <p>Finally, there are a few cases where <span class="sc">gdb</span>'s builtin
disassembler can fail for reasons that are not covered by
<code>MemoryError</code>.  In these cases, a <code>GdbError</code> will be raised. 
The contents of the exception will be a string describing the problem
the disassembler encountered. 
</p></blockquote></div>

   <p>Here is an example that registers a global disassembler.  The new
disassembler invokes the builtin disassembler, and then adds a
comment, <code>## Comment</code>, to each line of disassembly output:

<pre class="smallexample">     class ExampleDisassembler(gdb.disassembler.Disassembler):
         def __init__(self):
             super().__init__("ExampleDisassembler")
     
         def __call__(self, info):
             result = gdb.disassembler.builtin_disassemble(info)
             length = result.length
             text = result.string + "\t## Comment"
             return gdb.disassembler.DisassemblerResult(length, text)
     
     gdb.disassembler.register_disassembler(ExampleDisassembler())
</pre>
   <p>The following example creates a sub-class of <code>DisassembleInfo</code> in
order to intercept the <code>read_memory</code> calls, within
<code>read_memory</code> any bytes read from memory have the two 4-bit
nibbles swapped around.  This isn't a very useful adjustment, but
serves as an example.

<pre class="smallexample">     class MyInfo(gdb.disassembler.DisassembleInfo):
         def __init__(self, info):
             super().__init__(info)
     
         def read_memory(self, length, offset):
             buffer = super().read_memory(length, offset)
             result = bytearray()
             for b in buffer:
                 v = int.from_bytes(b, 'little')
                 v = (v &lt;&lt; 4) &amp; 0xf0 | (v &gt;&gt; 4)
                 result.append(v)
             return memoryview(result)
     
     class NibbleSwapDisassembler(gdb.disassembler.Disassembler):
         def __init__(self):
             super().__init__("NibbleSwapDisassembler")
     
         def __call__(self, info):
             info = MyInfo(info)
             return gdb.disassembler.builtin_disassemble(info)
     
     gdb.disassembler.register_disassembler(NibbleSwapDisassembler())
</pre>
   </body></html>

