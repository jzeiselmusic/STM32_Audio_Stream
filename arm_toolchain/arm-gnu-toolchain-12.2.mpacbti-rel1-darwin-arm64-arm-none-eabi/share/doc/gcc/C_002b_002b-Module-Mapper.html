<html lang="en">
<head>
<title>C++ Module Mapper - Using the GNU Compiler Collection (GCC)</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="Using the GNU Compiler Collection (GCC)">
<meta name="generator" content="makeinfo 4.8">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="C_002b_002b-Modules.html#C_002b_002b-Modules" title="C++ Modules">
<link rel="next" href="C_002b_002b-Module-Preprocessing.html#C_002b_002b-Module-Preprocessing" title="C++ Module Preprocessing">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
Copyright (C) 1988-2022 Free Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being ``Funding Free Software'', the Front-Cover
Texts being (a) (see below), and with the Back-Cover Texts being (b)
(see below).  A copy of the license is included in the section entitled
``GNU Free Documentation License''.

(a) The FSF's Front-Cover Text is:

     A GNU Manual

(b) The FSF's Back-Cover Text is:

     You have freedom to copy and modify this GNU Manual, like GNU
     software.  Copies published by the Free Software Foundation raise
     funds for GNU development.-->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<p>
<a name="C++-Module-Mapper"></a>
<a name="C_002b_002b-Module-Mapper"></a>
Next:&nbsp;<a rel="next" accesskey="n" href="C_002b_002b-Module-Preprocessing.html#C_002b_002b-Module-Preprocessing">C++ Module Preprocessing</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="C_002b_002b-Modules.html#C_002b_002b-Modules">C++ Modules</a>
<hr>
</div>

<h4 class="subsection">3.23.1 Module Mapper</h4>

<p><a name="index-C_002b_002b-Module-Mapper-3682"></a>
A module mapper provides a server or file that the compiler queries to
determine the mapping between module names and CMI files.  It is also
used to build CMIs on demand.  <em>Mapper functionality is in its
infancy and is intended for experimentation with build system
interactions.</em>

 <p>You can specify a mapper with the <samp><span class="option">-fmodule-mapper=</span><var>val</var></samp>
option or <samp><span class="env">CXX_MODULE_MAPPER</span></samp> environment variable.  The value may
have one of the following forms:

     <dl>
<dt><span class="roman">[</span><var>hostname</var><span class="roman">]</span><code>:</code><var>port</var><span class="roman">[</span><code>?</code><var>ident</var><span class="roman">]</span><dd>An optional hostname and a numeric port number to connect to.  If the
hostname is omitted, the loopback address is used.  If the hostname
corresponds to multiple IPV6 addresses, these are tried in turn, until
one is successful.  If your host lacks IPv6, this form is
non-functional.  If you must use IPv4 use
<samp><span class="option">-fmodule-mapper='|ncat </span><var>ipv4host</var> <var>port</var><span class="option">'</span></samp>.

     <br><dt><code>=</code><var>socket</var><span class="roman">[</span><code>?</code><var>ident</var><span class="roman">]</span><dd>A local domain socket.  If your host lacks local domain sockets, this
form is non-functional.

     <br><dt><code>|</code><var>program</var><span class="roman">[</span><code>?</code><var>ident</var><span class="roman">]</span> <span class="roman">[</span><var>args...</var><span class="roman">]</span><dd>A program to spawn, and communicate with on its stdin/stdout streams. 
Your <var>PATH</var> environment variable is searched for the program. 
Arguments are separated by space characters, (it is not possible for
one of the arguments delivered to the program to contain a space).  An
exception is if <var>program</var> begins with @.  In that case
<var>program</var> (sans @) is looked for in the compiler's internal
binary directory.  Thus the sample mapper-server can be specified
with <code>@g++-mapper-server</code>.

     <br><dt><code>&lt;&gt;</code><span class="roman">[</span><code>?</code><var>ident</var><span class="roman">]</span><br><dt><code>&lt;&gt;</code><var>inout</var><span class="roman">[</span><code>?</code><var>ident</var><span class="roman">]</span><br><dt><code>&lt;</code><var>in</var><code>&gt;</code><var>out</var><span class="roman">[</span><code>?</code><var>ident</var><span class="roman">]</span><dd>Named pipes or file descriptors to communicate over.  The first form,
<samp><span class="option">&lt;&gt;</span></samp>, communicates over stdin and stdout.  The other forms
allow you to specify a file descriptor or name a pipe.  A numeric value
is interpreted as a file descriptor, otherwise named pipe is opened. 
The second form specifies a bidirectional pipe and the last form
allows specifying two independent pipes.  Using file descriptors
directly in this manner is fragile in general, as it can require the
cooperation of intermediate processes.  In particular using stdin &amp;
stdout is fraught with danger as other compiler options might also
cause the compiler to read stdin or write stdout, and it can have
unfortunate interactions with signal delivery from the terminal.

     <br><dt><var>file</var><span class="roman">[</span><code>?</code><var>ident</var><span class="roman">]</span><dd>A mapping file consisting of space-separated module-name, filename
pairs, one per line.  Only the mappings for the direct imports and any
module export name need be provided.  If other mappings are provided,
they override those stored in any imported CMI files.  A repository
root may be specified in the mapping file by using `<samp><span class="samp">$root</span></samp>' as the
module name in the first active line.  Use of this option will disable
any default module-&gt;CMI name mapping.

 </dl>

 <p>As shown, an optional <var>ident</var> may suffix the first word of the
option, indicated by a `<samp><span class="samp">?</span></samp>' prefix.  The value is used in the
initial handshake with the module server, or to specify a prefix on
mapping file lines.  In the server case, the main source file name is
used if no <var>ident</var> is specified.  In the file case, all non-blank
lines are significant, unless a value is specified, in which case only
lines beginning with <var>ident</var> are significant.  The <var>ident</var>
must be separated by whitespace from the module name.  Be aware that
`<samp><span class="samp">&lt;</span></samp>', `<samp><span class="samp">&gt;</span></samp>', `<samp><span class="samp">?</span></samp>', and `<samp><span class="samp">|</span></samp>' characters are often
significant to the shell, and therefore may need quoting.

 <p>The mapper is connected to or loaded lazily, when the first module
mapping is required.  The networking protocols are only supported on
hosts that provide networking.  If no mapper is specified a default is
provided.

 <p>A project-specific mapper is expected to be provided by the build
system that invokes the compiler.  It is not expected that a
general-purpose server is provided for all compilations.  As such, the
server will know the build configuration, the compiler it invoked, and
the environment (such as working directory) in which that is
operating.  As it may parallelize builds, several compilations may
connect to the same socket.

 <p>The default mapper generates CMI files in a `<samp><span class="samp">gcm.cache</span></samp>'
directory.  CMI files have a `<samp><span class="samp">.gcm</span></samp>' suffix.  The module unit name
is used directly to provide the basename.  Header units construct a
relative path using the underlying header file name.  If the path is
already relative, a `<samp><span class="samp">,</span></samp>' directory is prepended.  Internal
`<samp><span class="samp">..</span></samp>' components are translated to `<samp><span class="samp">,,</span></samp>'.  No attempt is made
to canonicalize these filenames beyond that done by the preprocessor's
include search algorithm, as in general it is ambiguous when symbolic
links are present.

 <p>The mapper protocol was published as &ldquo;A Module Mapper&rdquo;
<a href="https://wg21.link/p1184">https://wg21.link/p1184</a>.  The implementation is provided by
<samp><span class="command">libcody</span></samp>, <a href="https://github.com/urnathan/libcody">https://github.com/urnathan/libcody</a>,
which specifies the canonical protocol definition.  A proof of concept
server implementation embedded in <samp><span class="command">make</span></samp> was described in
&rdquo;Make Me A Module&rdquo;, <a href="https://wg21.link/p1602">https://wg21.link/p1602</a>.

 </body></html>

